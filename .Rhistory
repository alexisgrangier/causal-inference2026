knitr::opts_chunk$set(fig.width=4, fig.height=3)
# install.packages(c('tidyverse', 'here'))
library(tidyverse)
library(here)
df <- readr::read_tsv("Lab 1/full_potential_outcomes.tsv")
getwd()
df <- readr::read_tsv("Lab 1/full_potential_outcomes.tsv")
df <- readr::read_tsv("full_potential_outcomes.tsv")
df %>% head()
df %>% select(y0, y1, t, y) %>% tail
a
a
# Import functions from GitHub
source("https://github.com/xuyiqing/lalonde/blob/main/tutorial/functions.R?raw=TRUE")
# Import functions from GitHub
source("https://github.com/xuyiqing/lalonde/blob/main/tutorial/functions.R?raw=TRUE")
# Select covariates for adjustment
covar <- c("age", "education", "black", "hispanic", "married",
"nodegree", "re74", "re75", "u74", "u75")
# Estimate the difference in means (experimental benchmark without adjustment)
diff(ldw, "re78", "treat")
# Load the Lalonde dataset
load("lalonde.RData")
mean(df$y1 - df$y0)
# Treatment assignment is correlated with potential outcomes at baseline
# This means treated and control units are not comparable
cor(df$t, df$y0)
cor(df$t, df$y1)
?cor
# Treatment assignment is correlated with potential outcomes at baseline
# This means treated and control units are not comparable
cor(df$t, df$y0)
cor(df$t, df$y1)
# We can visualize this: treated units have higher baseline potential outcomes
df %>% ggplot(aes(x = factor(t), y = y0)) +
geom_boxplot() +
labs(x = "Treatment", y = "Baseline Potential Outcome (Y0)")
knitr::opts_chunk$set(fig.width=4, fig.height=3)
# install.packages(c('tidyverse', 'here'))
library(tidyverse)
library(here)
df <- readr::read_tsv("full_potential_outcomes.tsv")
# Treatment assignment is correlated with potential outcomes at baseline
# This means treated and control units are not comparable
cor(df$t, df$y0)
cor(df$t, df$y1)
# We can visualize this: treated units have higher baseline potential outcomes
df %>% ggplot(aes(x = factor(t), y = y0)) +
geom_boxplot() +
labs(x = "Treatment", y = "Baseline Potential Outcome (Y0)")
# ATE (Average treatment effect - for everyone)
mean(df$y1 - df$y0)
## Same thing with fancy code
with(df, mean(y1) - mean(y0))
?with
View(df)
head(df())
head(df
head(df)
head(df)
# ATC (Average treatment on control)
mean(filter(df, t==0)$y1 - filter(df, t==0)$y0)
with(filter(df, t==0), mean(y1) - mean(y0))
# ATT (Average treatment on treated)
mean(filter(df, t==1)$y1 - filter(df, t==1)$y0)
# ATC (Average treatment on control)
mean(filter(df, t==0)$y1 - filter(df, t==0)$y0)
with(filter(df, t==0), mean(y1) - mean(y0))
# ATT (Average treatment on treated)
mean(filter(df, t==1)$y1 - filter(df, t==1)$y0)
with(filter(df, t==1), mean(y1) - mean(y0))
# Sample treatment assignment independently of potential outcomes
set.seed(123)
df$t_random <- sample(c(0, 1), nrow(df), replace = TRUE)
# Create observed outcome under this new treatment assignment
df$y_random <- ifelse(df$t_random == 1, df$y1, df$y0)
# Verify treatment is now independent of baseline potential outcomes
cor(df$t_random, df$y0)
cor(df$t_random, df$y1)
# Verify treatment is now independent of baseline potential outcomes
cor(df$t_random, df$y0)
cor(df$t_random, df$y1)
# Difference in means under random assignment
diff_in_means <- mean(df$y_random[df$t_random == 1]) - mean(df$y_random[df$t_random == 0])
# Compare to true ATE
true_ate <- mean(df$y1 - df$y0)
diff_in_means
true_ate
diff_in_means
# Compare to true ATE
true_ate <- mean(df$y1 - df$y0)
true_ate
?rnorm
df$x <- df$y0 + rnorm(nrow(df), 0, 0.5) # confounder related to baseline potential outcomes by adding noise
df$t_confound <- ifelse(df$x > median(df$x), 1, 0)
df$y_confound <- ifelse(df$t_confound==1, df$y1, df$y0)
# Treatment is now dependent of baseline potential outcomes
cor(df$t_confound, df$y0)
cor(df$t_confound, df$y1)
naive_diff <- with(df, mean(y_confound[t_confound==1]) - mean(y_confound[t_confound==0]))
true_ate   <- mean(df$y1 - df$y0)
naive_diff
true_ate
# They should be different because treatment is now confounded with x
# Now condition on x by stratifying
# Create strata of x (quintiles)
df$stratum <- cut(
df$x,
breaks = quantile(df$x, probs = seq(0, 1, 0.2)),
include.lowest = TRUE
)
# Within-stratum difference in means (only where both groups exist)
stratum_effects <- df %>%
dplyr::group_by(stratum) %>%
dplyr::summarise(
n = dplyr::n(),
n_treat = sum(t_confound == 1),
n_ctrl  = sum(t_confound == 0),
diff = ifelse(
n_treat > 0 & n_ctrl > 0,
mean(y_confound[t_confound == 1]) - mean(y_confound[t_confound == 0]),
NA_real_
),
.groups = "drop"
)
stratum_effects
View(stratum_effects)
# Weighted average of stratum diffs (dropping NA strata)
adj <- with(stratum_effects, weighted.mean(diff, w = n, na.rm = TRUE))
adj
# Using regression to adjust for x with complete data
coef(lm(y_confound ~ t_confound + x, data=df))["t_confound"]
