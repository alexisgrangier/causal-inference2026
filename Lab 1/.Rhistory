knitr::opts_chunk$set(fig.width=4, fig.height=3)
# install.packages(c('tidyverse', 'here'))
library(tidyverse)
install.packages(c('tidyverse', 'here'))
# install.packages(c('tidyverse', 'here'))
library(tidyverse)
install.packages('ggplot2')
# install.packages(c('tidyverse', 'here'))
library(tidyverse)
# install.packages(c('tidyverse', 'here'))
library(ggplot2)
R.version.string
Sys.which("R")
.libPaths()
"ggplot2" %in% rownames(installed.packages())
find.package("ggplot2", quiet = TRUE)
install.packages('ggplot2')
install.packages("Rtools")
# install.packages(c('tidyverse', 'here'))
library(tidyverse)
knitr::opts_chunk$set(fig.width=4, fig.height=3)
# install.packages(c('tidyverse', 'here'))
library(tidyverse)
install.packages("ggplot2")
# install.packages(c('tidyverse', 'here'))
library(tidyverse)
install.packages("ggplot2", lib = .libPaths()[1])
install.packages("ggplot2", type = "binary")
load("C:/Users/cpedr/Downloads/lalonde.RData")
load("C:/Users/cpedr/Downloads/lalonde.RData")
View(cps1)
knitr::opts_chunk$set(fig.width=4, fig.height=3)
# install.packages(c('tidyverse', 'here'))
library(tidyverse)
library(here)
df <- readr::read_tsv("full_potential_outcomes.tsv")
View(df)
df %>% head()
mean(filter(df, t == 1)$y) - mean(filter(df, t == 0)$y)
mean(df$y1 - df$y0)
# Verify treatment is now independent of baseline potential outcomes
cor(df$t_random, df$y0)
# Sample treatment assignment independently of potential outcomes
set.seed(123)
df$t_random <- sample(c(0, 1), nrow(df), replace = TRUE)
# Create observed outcome under this new treatment assignment
df$y_random <- ifelse(df$t_random == 1, df$y1, df$y0)
# Verify treatment is now independent of baseline potential outcomes
cor(df$t_random, df$y0)
cor(df$t_random, df$y1)
# Verify treatment is now independent of baseline potential outcomes
cor(df$t_random, df$y0)
cor(df$t_random, df$y1)
# Difference in means under random assignment
diff_in_means <- mean(df$y_random[df$t_random == 1]) - mean(df$y_random[df$t_random == 0])
diff_in_means
# Compare to true ATE
true_ate <- mean(df$y1 - df$y0)
true_ate
?sample
diff_in_means
true_ate
set.seed(123)
df$x <- df$y0 + rnorm(nrow(df), 0, 0.5) # confounder related to baseline potential outcomes by adding noise
df$t_confound <- ifelse(df$x > median(df$x), 1, 0)
df$x <- df$y0 + rnorm(nrow(df), 0, 0.5) # confounder related to baseline potential outcomes by adding noise
df$t_confound <- ifelse(df$x > median(df$x), 1, 0)
df$y_confound <- ifelse(df$t_confound==1, df$y1, df$y0)
df$y_confound <- ifelse(df$t_confound==1, df$y1, df$y0)
# Treatment is now dependent of baseline potential outcomes
cor(df$t_confound, df$y0)
cor(df$t_confound, df$y1)
naive_diff <- with(df, mean(y_confound[t_confound==1]) - mean(y_confound[t_confound==0]))
true_ate   <- mean(df$y1 - df$y0)
naive_diff
true_ate
# They should be different because treatment is now confounded with x
# Now condition on x by stratifying
# Create strata of x (quintiles)
df$stratum <- cut(
df$x,
breaks = quantile(df$x, probs = seq(0, 1, 0.2)),
include.lowest = TRUE
)
# Within-stratum difference in means (only where both groups exist)
stratum_effects <- df %>%
dplyr::group_by(stratum) %>%
dplyr::summarise(
n = dplyr::n(),
n_treat = sum(t_confound == 1),
n_ctrl  = sum(t_confound == 0),
diff = ifelse(
n_treat > 0 & n_ctrl > 0,
mean(y_confound[t_confound == 1]) - mean(y_confound[t_confound == 0]),
NA_real_
),
.groups = "drop"
)
stratum_effects
# Weighted average of stratum diffs (dropping NA strata)
adj <- with(stratum_effects, weighted.mean(diff, w = n, na.rm = TRUE))
adj
# Using regression to adjust for x with complete data
coef(lm(y_confound ~ t_confound + x, data=df))["t_confound"]
stratum_effects
adj
# Using regression to adjust for x with complete data
coef(lm(y_confound ~ t_confound + x, data=df))["t_confound"]
# Load the Lalonde dataset
load("lalonde.RData")
# Import functions from GitHub
source("https://github.com/xuyiqing/lalonde/blob/main/tutorial/functions.R?raw=TRUE")
# Select covariates for adjustment
covar <- c("age", "education", "black", "hispanic", "married",
"nodegree", "re74", "re75", "u74", "u75")
# Estimate the difference in means (experimental benchmark without adjustment)
diff(ldw, "re78", "treat")
# Estimate the ATE using regression adjustment
reg(ldw, "re78", "treat", covar) # Experimental dataset
reg(ldw_cps, "re78", "treat", covar) # Non-experimental dataset (control group from CPS1)
reg(ldw_psid, "re78", "treat", covar) # Non-experimental dataset (control group from PSID1)
# Overlap
ldw_ps <- assess_overlap(data = ldw, treat = "treat", cov = covar)
# Load the Lalonde dataset
load("lalonde.RData")
# Import functions from GitHub
source("https://github.com/xuyiqing/lalonde/blob/main/tutorial/functions.R?raw=TRUE")
# Select covariates for adjustment
covar <- c("age", "education", "black", "hispanic", "married",
"nodegree", "re74", "re75", "u74", "u75")
# Estimate the difference in means (experimental benchmark without adjustment)
diff(ldw, "re78", "treat")
View(diff)
# Estimate the ATE using regression adjustment
reg(ldw, "re78", "treat", covar) # Experimental dataset
reg(ldw_cps, "re78", "treat", covar) # Non-experimental dataset (control group from CPS1)
reg(ldw_psid, "re78", "treat", covar) # Non-experimental dataset (control group from PSID1)
# Overlap
ldw_ps <- assess_overlap(data = ldw, treat = "treat", cov = covar)
par(mfrow = c(1,2))
ldw_cps_ps <- assess_overlap(data = ldw_cps, treat = "treat", cov = covar)
ldw_cps_ps <- assess_overlap(data = ldw_cps, treat = "treat", cov = covar)
ldw_psid_ps <- assess_overlap(data = ldw_psid, treat = "treat", cov = covar)
